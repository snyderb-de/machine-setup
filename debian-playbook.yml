- name: New Debian Setup
  hosts: localhost
  vars:
    ansible_user: "{{ lookup('env', 'USER') }}"
  become: true
  become_method: su
  become_user: "{{ ansible_user }}"
  tasks:
    - name: Loading package lists from YAML file... 
      include_vars:
        file: install-packages.yml
        name: install-packages

    - name: Debug ansible_user check
      debug:
        var: ansible_user

    - name: Updating apt cache
      apt:
        update_cache: yes

    - name: Installing apt packages from YAML file
      apt:
        name: "{{ install-packages.apt_packages }}"
        state: present

    - name: Gathering system package facts
      package_facts:
        manager: auto

    - name: Installing snapd if its not installed
      apt:
        name: snapd
        state: present
      when: "'snap' not in ansible_facts['packages']"

    - name: Installing snap packages
      community.general.snap:
        name: "{{ item }}"
        state: present
      loop: "{{ install-packages.snap_packages }}"
      when: "'snap' in ansible_facts.packages"

